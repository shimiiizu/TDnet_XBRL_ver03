<script>
    function renderChart(type, data, stock) {
        const ctx = document.getElementById(`${type}Chart`).getContext('2d');
        const buttons = document.querySelectorAll(`#${type}Metrics .metric-button`);
        let activeMetric = buttons[0].dataset.metric;
        const checkbox = document.getElementById(`showStockIn${type.toUpperCase()}`);
        checkbox.checked = true; // 初期ON！

        buttons.forEach(btn => btn.onclick = () => {
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            activeMetric = btn.dataset.metric;
            drawChart();
        });

        checkbox.onchange = drawChart;

        function drawChart() {
            // チャート破棄
            if (type === 'bs' && bsChart) { bsChart.destroy(); bsChart = null; }
            if (type === 'pl' && plChart) { plChart.destroy(); plChart = null; }

            // ラベルは株価の日付（日次）
            const labels = stock.map(s => s.date);

            // BS/PLの値を「年月」でマッチング（例: 2024-03-01 → 2024-03）
            const dataMap = {};
            data.forEach(d => {
                const key = (d.date || d.term).substring(0, 7); // "2024-03"
                dataMap[key] = d[activeMetric];
            });

            // 株価の日付から年月を取り出し、対応するBS/PL値を割り当て
            const values = labels.map(date => {
                const ym = date.substring(0, 7); // "2024-03"
                return dataMap[ym] ?? null;
            });

            const datasets = [{
                label: metricNames[activeMetric],
                data: values,
                borderColor: '#2196F3',
                backgroundColor: 'rgba(33,150,243,0.2)',
                yAxisID: 'y',
                spanGaps: true,
                tension: 0.1
            }];

            if (checkbox.checked) {
                datasets.push({
                    label: '株価（円）',
                    data: stock.map(s => s.price),
                    borderColor: '#FF9800',
                    backgroundColor: 'rgba(255,152,0,0.2)',
                    yAxisID: 'y1',
                    spanGaps: true,
                    tension: 0.1
                });
            }

            const chart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day', displayFormats: { day: 'MM/dd' } },
                            title: { display: true, text: '日付' }
                        },
                        y: { position: 'left', title: { display: true, text: '金額 (百万円)' } },
                        y1: {
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: '株価 (円)' },
                            min: Math.min(...stock.map(s => s.price)) * 0.95,
                            max: Math.max(...stock.map(s => s.price)) * 1.05
                        }
                    }
                }
            });

            if (type === 'bs') bsChart = chart;
            else plChart = chart;
        }

        drawChart();
    }
</script>