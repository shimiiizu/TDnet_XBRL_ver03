<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>財務データ分析ツール</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1400px; margin: 0 auto; padding: 20px; background:#f5f5f5;}
        h1 {color:#333;text-align:center;}
        .controls {background:#fff;padding:20px;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,.1);}
        label {display:block;margin-bottom:8px;font-weight:bold;color:#555;}
        select,input[type=text]{width:100%;padding:10px;font-size:16px;border:1px solid #ddd;border-radius:4px;margin-bottom:10px;}
        input[type=checkbox]{margin-right:8px;}
        button {width:100%;padding:10px;font-size:16px;background:#2196F3;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:15px;}
        button:hover {background:#1976D2;}
        .tabs {display:flex;gap:10px;margin-bottom:20px;background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1);}
        .tab {flex:1;padding:12px;font-size:16px;background:#e0e0e0;color:#333;border:none;border-radius:4px;cursor:pointer;transition:all .3s;font-weight:bold;}
        .tab:hover {background:#d0d0d0;}
        .tab.active {background:#2196F3;color:#fff;}
        .tab-content {display:none;}
        .tab-content.active {display:block;}
        .metric-selector {display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-top:20px;}
        .metric-button {padding:12px;font-size:14px;background:#e0e0e0;color:#333;border:2px solid transparent;border-radius:4px;cursor:pointer;transition:all .3s;}
        .metric-button:hover {background:#d0d0d0;}
        .metric-button.active {background:#2196F3;color:#fff;border-color:#1976D2;}
        .chart-container {background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1);height:350px;margin-bottom:20px;position:relative;}
        .stock-checkbox {background:#fff3e0;padding:12px;border-radius:8px;margin-top:15px;border-left:4px solid #ff9800;}
        .stock-checkbox label {display:inline;color:#e65100;cursor:pointer;}
        #loading {text-align:center;padding:40px;color:#666;}
        .info-box {background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #2196F3;}
        .info-box p {margin:5px 0;color:#1565C0;}
    </style>
</head>
<body>
    <h1>財務データ分析ツール</h1>
    <div class="info-box">
        <p><strong>モックデータで動作中！</strong>（API不要）</p>
        <p>株価もBS/PLも表示されます。チェックボックスでON/OFF可能。</p>
    </div>

    <div class="controls">
        <label>会社を選択:</label>
        <select id="companySelect">
            <option value="9504">中部電力 (9504)</option>
            <option value="7203">トヨタ自動車 (7203)</option>
        </select>
    </div>

    <div class="tabs" id="mainTabs">
        <button class="tab active" onclick="switchTab('bs')">貸借対照表 (BS)</button>
        <button class="tab" onclick="switchTab('pl')">損益計算書 (PL)</button>
    </div>

    <div id="bs-content" class="tab-content active">
        <div class="controls">
            <label>表示する指標:</label>
            <div class="metric-selector" id="bsMetrics">
                <button class="metric-button active" data-metric="assets">総資産</button>
                <button class="metric-button" data-metric="netAssets">純資産</button>
            </div>
            <div class="stock-checkbox">
                <label><input type="checkbox" id="showStockInBS" checked> 株価を重ねて表示</label>
            </div>
        </div>
        <div class="chart-container"><canvas id="bsChart"></canvas></div>
    </div>

    <div id="pl-content" class="tab-content">
        <div class="controls">
            <label>表示する指標:</label>
            <div class="metric-selector" id="plMetrics">
                <button class="metric-button active" data-metric="netSales">売上高</button>
                <button class="metric-button" data-metric="operatingIncome">営業利益</button>
            </div>
            <div class="stock-checkbox">
                <label><input type="checkbox" id="showStockInPL" checked> 株価を重ねて表示</label>
            </div>
        </div>
        <div class="chart-container"><canvas id="plChart"></canvas></div>
    </div>

    <script>
        const metricNames = { assets:'総資産', netAssets:'純資産', netSales:'売上高', operatingIncome:'営業利益' };
        let bsChart = null, plChart = null;

        // モックデータ（年月でマッチ）
        const data = {
            bs: [
                { term: "2024-03", assets: 1000, netAssets: 400 },
                { term: "2024-06", assets: 1050, netAssets: 420 },
                { term: "2024-09", assets: 1100, netAssets: 440 },
                { term: "2024-12", assets: 1150, netAssets: 460 }
            ],
            pl: [
                { term: "2024-03", netSales: 500, operatingIncome: 50 },
                { term: "2024-06", netSales: 520, operatingIncome: 52 },
                { term: "2024-09", netSales: 540, operatingIncome: 54 },
                { term: "2024-12", netSales: 560, operatingIncome: 56 }
            ],
            stock: [
                { date: "2024-03-01", price: 2800 },
                { date: "2024-03-15", price: 2850 },
                { date: "2024-03-31", price: 2900 },
                { date: "2024-06-01", price: 2950 },
                { date: "2024-06-15", price: 2980 },
                { date: "2024-06-30", price: 3000 },
                { date: "2024-09-01", price: 3050 },
                { date: "2024-09-15", price: 3080 },
                { date: "2024-09-30", price: 3100 },
                { date: "2024-12-01", price: 3150 },
                { date: "2024-12-15", price: 3180 },
                { date: "2024-12-31", price: 3200 }
            ]
        };

        // 初期化
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('mainTabs').style.display = 'flex';
            document.getElementById('companySelect').onchange = () => loadData();
            loadData();
        });

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}-content`).classList.add('active');
        }

        function loadData() {
            renderChart('bs', data.bs, data.stock);
            renderChart('pl', data.pl, data.stock);
        }

        function renderChart(type, bsplData, stock) {
            const ctx = document.getElementById(`${type}Chart`).getContext('2d');
            const buttons = document.querySelectorAll(`#${type}Metrics .metric-button`);
            let activeMetric = buttons[0].dataset.metric;
            const checkbox = document.getElementById(`showStockIn${type.toUpperCase()}`);

            buttons.forEach(btn => btn.onclick = () => {
                buttons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                activeMetric = btn.dataset.metric;
                drawChart();
            });

            checkbox.onchange = drawChart;

            function drawChart() {
                // チャート破棄
                if (type === 'bs' && bsChart) { bsChart.destroy(); bsChart = null; }
                if (type === 'pl' && plChart) { plChart.destroy(); plChart = null; }

                const labels = stock.map(s => s.date);
                const label = metricNames[activeMetric];

                // 年月でマッチ
                const map = {};
                bsplData.forEach(d => { map[d.term] = d[activeMetric]; });
                const values = labels.map(date => {
                    const ym = date.substring(0, 7); // "2024-03"
                    return map[ym] ?? null;
                });

                const datasets = [{
                    label,
                    data: values,
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33,150,243,0.2)',
                    yAxisID: 'y',
                    spanGaps: true
                }];

                if (checkbox.checked) {
                    datasets.push({
                        label: '株価（円）',
                        data: stock.map(s => s.price),
                        borderColor: '#FF9800',
                        backgroundColor: 'rgba(255,152,0,0.2)',
                        yAxisID: 'y1',
                        spanGaps: true
                    });
                }

                const chart = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top' } },
                        scales: {
                            x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'MM/dd' } } },
                            y: { position: 'left', title: { display: true, text: '金額 (百万円)' } },
                            y1: { position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: '株価 (円)' } }
                        }
                    }
                });

                if (type === 'bs') bsChart = chart;
                else plChart = chart;
            }

            drawChart();
        }
    </script>
</body>
</html>