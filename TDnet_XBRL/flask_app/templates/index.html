<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>財務データ分析ツール - BS & PL</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1400px; margin: 0 auto; padding: 20px; background:#f5f5f5;}
        h1 {color:#333;text-align:center;}
        .controls {background:#fff;padding:20px;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,.1);}
        label {display:block;margin-bottom:8px;font-weight:bold;color:#555;}
        select,input[type=text]{width:100%;padding:10px;font-size:16px;border:1px solid #ddd;border-radius:4px;margin-bottom:10px;}
        input[type=checkbox]{margin-right:8px;}
        button {width:100%;padding:10px;font-size:16px;background:#2196F3;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:15px;}
        button:hover {background:#1976D2;}
        .tabs {display:flex;gap:10px;margin-bottom:20px;background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1);}
        .tab {flex:1;padding:12px;font-size:16px;background:#e0e0e0;color:#333;border:none;border-radius:4px;cursor:pointer;transition:all .3s;font-weight:bold;}
        .tab:hover {background:#d0d0d0;}
        .tab.active {background:#2196F3;color:#fff;}
        .tab-content {display:none;}
        .tab-content.active {display:block;}
        .metric-selector {display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-top:20px;}
        .metric-button {padding:12px;font-size:14px;background:#e0e0e0;color:#333;border:2px solid transparent;border-radius:4px;cursor:pointer;transition:all .3s;}
        .metric-button:hover {background:#d0d0d0;}
        .metric-button.active {background:#2196F3;color:#fff;border-color:#1976D2;}

        /* 高さ 350px 固定 */
        .chart-container {
            background:#fff;
            padding:20px;
            border-radius:8px;
            box-shadow:0 2px 4px rgba(0,0,0,.1);
            margin-bottom:20px;
            position:relative;
            height: 350px;
            overflow: hidden;
        }

        .stock-checkbox {background:#fff3e0;padding:12px;border-radius:8px;margin-top:15px;border-left:4px solid #ff9800;}
        .stock-checkbox label {display:inline;color:#e65100;cursor:pointer;}
        #loading {text-align:center;padding:40px;color:#666;}
        .info-box {background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #2196F3;}
        .info-box p {margin:5px 0;color:#1565C0;}
    </style>
</head>
<body>
    <h1>財務データ分析ツール</h1>

    <div class="info-box">
        <p><strong>横軸表示: 会計年度とクオーター（FY2023 Q1形式）</strong></p>
        <p>BSとPLの両方で統一されたクオーター表記を使用します。</p>
    </div>

    <div class="controls">
        <label for="codeInput">証券コードで検索:</label>
        <input type="text" id="codeInput" placeholder="例: 9504" />
        <button id="searchButton">検索</button>

        <label for="companySelect" style="margin-top:20px;">または会社を選択:</label>
        <select id="companySelect"><option value="">読み込み中...</option></select>
    </div>

    <div class="tabs" id="mainTabs" style="display:none;">
        <button class="tab active" onclick="switchTab('bs')">貸借対照表 (BS)</button>
        <button class="tab" onclick="switchTab('pl')">損益計算書 (PL)</button>
    </div>

    <!-- BS -->
    <div id="bs-content" class="tab-content active">
        <div class="controls">
            <label>表示する指標:</label>
            <div class="metric-selector" id="bsMetrics">
                <button class="metric-button active" data-metric="assets">総資産</button>
                <button class="metric-button" data-metric="netAssets">純資産</button>
                <button class="metric-button" data-metric="currentAssets">流動資産</button>
                <button class="metric-button" data-metric="cash">現金・預金</button>
                <button class="metric-button" data-metric="ppe">有形固定資産</button>
                <button class="metric-button" data-metric="retainedEarnings">利益剰余金</button>
            </div>
            <div class="stock-checkbox">
                <label><input type="checkbox" id="showStockInBS" checked> 株価を重ねて表示</label>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="bsChart" height="350"></canvas>
        </div>
    </div>

    <!-- PL -->
    <div id="pl-content" class="tab-content">
        <div class="controls">
            <label>表示する指標:</label>
            <div class="metric-selector" id="plMetrics">
                <button class="metric-button active" data-metric="netSales">売上高</button>
                <button class="metric-button" data-metric="operatingIncome">営業利益</button>
                <button class="metric-button" data-metric="ordinaryIncome">経常利益</button>
                <button class="metric-button" data-metric="netIncome">純利益</button>
            </div>
            <div class="stock-checkbox">
                <label><input type="checkbox" id="showStockInPL" checked> 株価を重ねて表示</label>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="plChart" height="350"></canvas>
        </div>
    </div>

    <div id="loading" style="display:none;">データを読み込んでいます...</div>

    <script>
        const metricNames = {
            assets: '総資産', netAssets: '純資産', currentAssets: '流動資産',
            cash: '現金・預金', ppe: '有形固定資産', retainedEarnings: '利益剰余金',
            netSales: '売上高', operatingIncome: '営業利益',
            ordinaryIncome: '経常利益', netIncome: '純利益'
        };

        let bsChart = null, plChart = null;

        async function loadCompanies() {
            const select = document.getElementById('companySelect');
            const loading = document.getElementById('loading');
            try {
                loading.style.display = 'block';
                const resp = await fetch('/api/companies');
                if (!resp.ok) throw new Error('Network error');
                const companies = await resp.json();

                select.innerHTML = '<option value="">会社を選択してください</option>';
                companies.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.code;
                    opt.textContent = `${c.name} (${c.code})`;
                    select.appendChild(opt);
                });

                select.onchange = async () => {
                    if (select.value) {
                        const comp = companies.find(c => c.code === select.value);
                        await loadAllData(comp.code, comp.name);
                    }
                };

                document.getElementById('searchButton').onclick = searchByCode;
                loading.style.display = 'none';
            } catch (e) {
                console.error(e);
                alert('会社リスト取得失敗');
                loading.style.display = 'none';
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}-content`).classList.add('active');
        }

        async function loadAllData(code, name) {
            document.getElementById('mainTabs').style.display = 'flex';
            document.getElementById('loading').style.display = 'block';
            try {
                const [bsResp, plResp, stockResp] = await Promise.all([
                    fetch(`/api/bs-data/${encodeURIComponent(name)}`),
                    fetch(`/api/pl-data/${code}`),
                    fetch(`/api/stock-price/${code}`)
                ]);

                const bs = await bsResp.json();
                const pl = await plResp.json();
                const stock = await stockResp.json();

                renderChart('bs', bs, stock);
                renderChart('pl', pl, stock);
            } catch (e) {
                console.error(e);
                alert('データ取得失敗');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderChart(type, data, stock) {
            const ctx = document.getElementById(`${type}Chart`).getContext('2d');
            const buttons = document.querySelectorAll(`#${type}Metrics .metric-button`);
            let activeMetric = buttons[0].dataset.metric;
            const checkbox = document.getElementById(`showStockIn${type.toUpperCase()}`);

            buttons.forEach(btn => btn.onclick = () => {
                buttons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                activeMetric = btn.dataset.metric;
                drawChart();
            });
            checkbox.onchange = drawChart;

            function drawChart() {
                if (type === 'bs' && bsChart) { bsChart.destroy(); bsChart = null; }
                if (type === 'pl' && plChart) { plChart.destroy(); plChart = null; }

                // クオーター表記を使用
                const labels = data.map(d => d.term);
                const label = metricNames[activeMetric];

                // 財務データの値
                const values = data.map(d => d[activeMetric] ?? null);

                const datasets = [{
                    label,
                    data: values,
                    borderColor: '#2196F3',
                    backgroundColor: 'rgba(33,150,243,0.2)',
                    yAxisID: 'y',
                    spanGaps: true,
                    fill: true
                }];

                // 株価データを重ねる場合
                if (checkbox.checked && stock.length) {
                    // 株価データもクオーター表記に変換済み
                    const stockMap = {};
                    stock.forEach(s => {
                        stockMap[s.term] = s.price;
                    });

                    // labelsに対応する株価を取得
                    const stockPrices = labels.map(term => stockMap[term] ?? null);

                    datasets.push({
                        label: '株価（円）',
                        data: stockPrices,
                        borderColor: '#FF9800',
                        backgroundColor: 'transparent',
                        yAxisID: 'y1',
                        spanGaps: true,
                        fill: false,
                        pointRadius: 2,
                        borderWidth: 2
                    });
                }

                const chart = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        // ツールチップにクオーター情報を表示
                                        return context[0].label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'category',  // 時系列ではなくカテゴリとして扱う
                                title: { display: true, text: '会計年度・クオーター' },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                position: 'left',
                                title: { display: true, text: '金額 (百万円)' }
                            },
                            y1: {
                                position: 'right',
                                grid: { drawOnChartArea: false },
                                title: { display: true, text: '株価 (円)' }
                            }
                        }
                    }
                });

                if (type === 'bs') bsChart = chart;
                else plChart = chart;
            }
            drawChart();
        }

        async function searchByCode() {
            const code = document.getElementById('codeInput').value.trim();
            if (!code) return alert('証券コードを入力してください');
            try {
                const resp = await fetch('/api/companies');
                const companies = await resp.json();
                const comp = companies.find(c => c.code === code);
                if (!comp) return alert('会社が見つかりません');
                document.getElementById('companySelect').value = code;
                await loadAllData(code, comp.name);
            } catch (e) {
                alert('検索失敗');
            }
        }

        window.addEventListener('DOMContentLoaded', loadCompanies);
    </script>
</body>
</html>